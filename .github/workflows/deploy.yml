name: Deploy Multi-Tenant App to Kubernetes 
on:
  push:
    branches:
      - main
      - dev
      - 'feature/*'
  pull_request:
    branches:
      - main
      - dev
  workflow_dispatch:
    inputs:
      tenant:
        description: 'tenant/user id (e.g., user1)'
        required: true
      domain:
        description: 'domain to bind (e.g., user1.example.com). If empty, will use user.<BASE_DOMAIN>'
        required: false
      branch:
        description: 'branch or ref to build from'
        required: false
        default: 'main'
      tag:
        description: 'image tag override (optional)'
        required: false
env:
  ACR_NAME: ${{ secrets.ACR_NAME }}
  BASE_DOMAIN: ${{ secrets.BASE_DOMAIN }}
  CLUSTER_ISSUER: letsencrypt-azure-dns
jobs:
  build_push:
    runs-on: ubuntu-latest
    outputs:
      image: ${{ steps.set_image.outputs.image }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}
      - name: Login to registry
        uses: docker/login-action@v2
        with:
          registry: ${{ secrets.ACR_NAME }}.azurecr.io
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}
      - name: Build and push image
        id: set_image
        run: |
          USER=${{ github.event.inputs.tenant }}
          TAG=${{ github.event.inputs.tag || github.sha }}
          IMAGE=${{ env.ACR_NAME }}.azurecr.io/${USER}-app:${TAG}
          docker build -t ${IMAGE} ./app
          docker push ${IMAGE}
          echo "::set-output name=image::${IMAGE}"
  deploy:
    needs: build_push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (get templates)
        uses: actions/checkout@v4
      - name: Configure Kubeconfig
        run: |
          echo "${{ secrets.KUBE_CONFIG }}" | base64 --decode > kubeconfig.yaml
          mkdir -p ~/.kube && mv kubeconfig.yaml ~/.kube/config
      - name: Prepare variables
        run: |
          USER=${{ github.event.inputs.tenant || secrets.TENANT }}
          DOMAIN=${{ github.event.inputs.domain || (${USER} + '.' + '${{ env.BASE_DOMAIN }}') }}
          NS=${USER}-ns
          APP=${USER}-app
          IMAGE=${{ needs.build_push.outputs.image }}
          echo "USER=${USER}" >> $GITHUB_ENV
          echo "DOMAIN=${DOMAIN}" >> $GITHUB_ENV
          echo "NS=${NS}" >> $GITHUB_ENV
          echo "APP=${APP}" >> $GITHUB_ENV
          echo "IMAGE=${IMAGE}" >> $GITHUB_ENV
      - name: Create namespace and apply quotas/pdb/hpa
        run: |
          kubectl get ns ${NS} || kubectl create ns ${NS}
          sed -e "s|{{NAMESPACE}}|${NS}|g" k8s/templates/resourcequota.yaml | kubectl apply -f -
          sed -e "s|{{NAMESPACE}}|${NS}|g; s|{{APP_NAME}}|${APP}|g" k8s/templates/pdb.yaml | kubectl apply -f -
          sed -e "s|{{NAMESPACE}}|${NS}|g; s|{{APP_NAME}}|${APP}|g" k8s/templates/hpa.yaml | kubectl apply -f -
          sed -e "s|{{NAMESPACE}}|${NS}|g; s|{{APP_NAME}}|${APP}|g" k8s/templates/networkpolicy.yaml | kubectl apply -f -
      - name: Deploy app (with rollback on failure)
        run: |
          sed -e "s|{{NAMESPACE}}|${NS}|g; s|{{APP_NAME}}|${APP}|g; s|{{IMAGE}}|${IMAGE}|g; s|{{TENANT}}|${USER}|g" k8s/templates/deployment.yaml > /tmp/deploy-${USER}.yaml
          kubectl apply -f /tmp/deploy-${USER}.yaml
          kubectl -n ${NS} rollout status deployment/${APP} --timeout=120s || (echo 'rollout failed, undoing' && kubectl -n ${NS} rollout undo deployment/${APP} && exit 1)
      - name: Create Ingress + request TLS via cert-manager (DNS-01 via Azure DNS)
        run: |
          sed -e "s|{{NAMESPACE}}|${NS}|g; s|{{APP_NAME}}|${APP}|g; s|{{DOMAIN}}|${DOMAIN}|g; s|{{CLUSTER_ISSUER}}|${{ env.CLUSTER_ISSUER }}|g" k8s/templates/ingress.yaml > /tmp/ing-${USER}.yaml
          kubectl apply -f /tmp/ing-${USER}.yaml
      - name: Publish WebsiteCreated event to Kafka
        run: |
          kubectl -n kafka run kafka-producer --restart=Never --rm -it --image=bitnami/kafka:3.6.0 -- bash -c "echo '{"event":"WebsiteCreated","tenant":"'${APP}'","domain":"'${DOMAIN}'"}' | kafka-console-producer.sh --broker-list kafka.kafka.svc.cluster.local:9092 --topic website-events"
